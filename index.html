<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LithMate PRO — Regras</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%233DA4FF'/><text x='50' y='58' font-size='45' text-anchor='middle' fill='white' font-family='Arial'>L</text></svg>">
<style>
  :root{
    --bg:#0b1116; --panel:#0f1720; --glass:rgba(255,255,255,0.03);
    --accent:#3DA4FF; --accent-2:#70c3ff; --muted:#9fb0c6; --card:#0e1822;
    --radius:14px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:Inter,Segoe UI,Arial; background:linear-gradient(180deg,#071017 0%, #0b1218 100%);
    color:#e7f2ff; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }

  /* TOP NAV */
  .top{
    position:fixed; top:0; left:0; right:0; height:76px;
    display:flex; align-items:center; gap:18px; padding:12px 20px;
    background:rgba(6,13,18,0.45); backdrop-filter: blur(8px); border-bottom:1px solid rgba(255,255,255,0.03); z-index:60;
  }
  .logoWrap{display:flex;align-items:center;gap:12px;cursor:default}
  .logoSVG{width:48px;height:48px}
  .brand{font-weight:800; letter-spacing:-0.6px; font-size:18px; color:var(--accent)}
  nav{margin-left:8px; display:flex; gap:8px; align-items:center}
  .navBtn{background:transparent;border:0;padding:8px 12px;border-radius:10px;color:var(--muted);cursor:pointer;font-weight:600}
  .navBtn.active{color:var(--accent); background:linear-gradient(90deg, rgba(61,164,255,0.08), rgba(112,195,255,0.03)); border:1px solid rgba(61,164,255,0.08)}

  /* container */
  .page{max-width:1100px;margin:110px auto 80px;padding:18px}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:20px}
  .panel{background:var(--card); border-radius:var(--radius); padding:18px;border:1px solid rgba(255,255,255,0.03); box-shadow:0 10px 30px rgba(2,8,12,0.6)}

  /* Post form */
  .h1{font-size:20px;color:var(--accent);font-weight:700;margin:0 0 8px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input[type="text"], textarea, select{
    width:100%; padding:12px 14px; border-radius:10px; border:1px solid rgba(255,255,255,0.03); background:rgba(10,15,20,0.45);
    color:#e8f6ff; font-size:15px; outline:none; resize:vertical;
  }
  textarea{min-height:140px}
  .row{display:flex;gap:10px}
  .btn{display:inline-block;padding:12px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
  .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#042533}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted)}

  /* search / filters */
  .searchBar{display:flex;gap:10px;align-items:center;margin-bottom:12px}
  .searchBar input{flex:1;padding:12px;border-radius:12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);color:#e6f3ff}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}
  .chip{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);cursor:pointer;color:var(--muted);font-weight:600}
  .chip.active{background:linear-gradient(90deg, rgba(61,164,255,0.08), rgba(112,195,255,0.03)); color:var(--accent)}

  /* rules list */
  .list{display:flex;flex-direction:column;gap:12px}
  .rule{
    padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.02); display:flex; justify-content:space-between; gap:12px;cursor:pointer;
  }
  .rule:hover{transform:translateY(-4px);transition:all .18s}
  .ruleLeft{flex:1}
  .title{font-weight:700;color:#eaf7ff}
  .meta{font-size:13px;color:var(--muted);margin-top:6px}
  .tag{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,0.02);font-weight:700;font-size:12px;color:var(--accent);background:rgba(61,164,255,0.04)}

  .ruleActions{display:flex;flex-direction:column;gap:8px;align-items:flex-end}
  .actRow{display:flex;gap:8px}

  .small{font-size:13px;color:var(--muted)}

  /* modal */
  .modalBg{position:fixed;inset:0;background:rgba(1,3,6,0.68);display:none;justify-content:center;align-items:center;z-index:120}
  .modal{width:92%;max-width:720px;background:linear-gradient(180deg,#081019,#071018);border-radius:14px;padding:20px;border:1px solid rgba(255,255,255,0.03)}
  .modal .title{font-size:20px}
  .modal .body{margin-top:10px;color:var(--muted);line-height:1.5}
  .closeX{cursor:pointer;color:var(--muted);font-weight:800}

  /* right column */
  .cardSmall{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:12px;border-radius:12px}
  .fav{display:flex;align-items:center;gap:10px;justify-content:space-between}

  /* footer utilities */
  .util{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
  .linkBtn{background:transparent;border:1px solid rgba(255,255,255,0.03);padding:8px 10px;border-radius:10px;color:var(--muted);cursor:pointer}

  /* responsive */
  @media (max-width:980px){ .grid{grid-template-columns:1fr} .top{padding:10px} .page{margin-top:120px} }
</style>
</head>
<body>

<!-- TOP -->
<div class="top">
  <div class="logoWrap">
    <!-- Animated Inline SVG logo -->
    <svg class="logoSVG" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
      <defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="#3DA4FF"/><stop offset="1" stop-color="#70C3FF"/></linearGradient></defs>
      <circle cx="50" cy="50" r="45" fill="url(#g)" opacity="0.95"/>
      <path d="M36 66 L50 30 L64 66 Z" fill="#042533" opacity="0.95"/>
      <animateTransform attributeName="transform" type="rotate" values="0 50 50;6 50 50;0 50 50" dur="6s" repeatCount="indefinite"/>
    </svg>
    <div>
      <div class="brand brandName" style="font-weight:900;color:var(--accent)">LithMate</div>
      <div class="small">Regras • Sistema público</div>
    </div>
  </div>

  <nav>
    <button class="navBtn active" data-view="home">Regras</button>
    <button class="navBtn" data-view="new">Publicar</button>
    <button class="navBtn" data-view="export">Export/Import</button>
    <button class="navBtn" data-view="about">Sobre</button>
  </nav>
</div>

<!-- MAIN PAGE -->
<div class="page">
  <div class="grid">

    <!-- LEFT: Conteúdo principal -->
    <div>
      <!-- Search + Filters -->
      <div class="panel" id="view-home">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="h1">Regras publicadas</div>
            <div class="small">Pesquise, filtre, copie e compartilhe.</div>
          </div>
          <div class="small" id="stats">—</div>
        </div>

        <div style="height:12px"></div>
        <div class="searchBar">
          <input id="searchInput" placeholder="Pesquisar por título ou texto..." />
          <select id="sortSelect" style="width:160px;border-radius:10px;padding:10px;background:transparent;color:#dff6ff;border:1px solid rgba(255,255,255,0.03)">
            <option value="new">Mais recentes</option>
            <option value="old">Mais antigas</option>
            <option value="category">Por categoria</option>
          </select>
        </div>

        <div class="chips" id="chips">
          <!-- dynamic chips -->
        </div>

        <div class="list" id="rulesList">
          <!-- rules -->
        </div>

        <div style="display:flex;gap:10px;justify-content:center;margin-top:14px">
          <button class="linkBtn" id="prevPage">Anterior</button>
          <div class="small" id="pageInfo">Página 1</div>
          <button class="linkBtn" id="nextPage">Próxima</button>
        </div>
      </div>

      <!-- NEW RULE VIEW -->
      <div class="panel" id="view-new" style="display:none">
        <div class="h1">Publicar nova regra</div>
        <div class="small">Ao publicar, você recebe um token que permite editar/deletar esta regra (guardado no seu navegador).</div>
        <div style="height:12px"></div>

        <label>Título</label>
        <input id="newTitle" placeholder="Ex: Regras gerais do grupo" />

        <label>Categoria</label>
        <select id="newCategory">
          <option>Geral</option><option>Comportamento</option><option>Conteúdo</option><option>Banimentos</option><option>Moderação</option>
        </select>

        <label>Conteúdo (use quebras de linha para separar)</label>
        <textarea id="newText" placeholder="Digite a regra completa..."></textarea>

        <div style="display:flex;gap:10px;margin-top:10px">
          <button class="btn primary" id="publishBtn">Publicar regra</button>
          <button class="btn ghost" id="clearBtn">Limpar</button>
        </div>

        <div style="height:12px"></div>
        <div class="small">Ao publicar, guarde o token. Ele também será salvo automaticamente no seu navegador.</div>
      </div>

      <!-- EXPORT/IMPORT VIEW -->
      <div class="panel" id="view-export" style="display:none">
        <div class="h1">Exportar e Importar Regras</div>
        <div style="height:8px"></div>
        <div class="cardSmall">
          <div class="small">Exportar todas as regras (JSON)</div>
          <div style="height:8px"></div>
          <div style="display:flex;gap:8px">
            <button class="linkBtn" id="exportBtn">Exportar JSON</button>
            <button class="linkBtn" id="downloadSample">Baixar amostra JSON</button>
            <label style="margin-left:auto">
              <input type="file" id="importFile" style="display:none" />
              <button class="linkBtn" id="importBtn">Importar JSON</button>
            </label>
          </div>
        </div>
        <div style="height:16px"></div>
        <div class="small">Importe apenas JSON formatado corretamente (a importação cria novos registros).</div>
      </div>

      <!-- ABOUT VIEW -->
      <div class="panel" id="view-about" style="display:none">
        <div class="h1">Sobre LithMate — Sistema de Regras</div>
        <div class="small" style="margin-top:8px">Versão PRO pública — criado por você. Recursos:</div>
        <ul class="small" style="margin-top:10px;color:var(--muted)">
          <li>Publicar regras com token de edição</li>
          <li>Pesquisar, filtrar e favoritar</li>
          <li>Compartilhar via link</li>
          <li>Export/Import JSON</li>
        </ul>
      </div>
    </div>

    <!-- RIGHT: utilidades -->
    <div>
      <div class="panel cardSmall" id="rightPanel">
        <div style="display:flex;align-items:center;gap:12px">
          <div style="width:48px;height:48px;border-radius:12px;background:linear-gradient(90deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:#041f24;font-weight:900">L</div>
          <div>
            <div style="font-weight:800">LithMate</div>
            <div class="small">Sistema de Regras — público</div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div style="display:flex;flex-direction:column;gap:8px">
          <div class="fav">
            <div>
              <div class="small">Favoritos salvos</div>
              <div id="favCount" style="font-weight:800">0</div>
            </div>
            <button class="linkBtn" id="clearFavs">Limpar favoritos</button>
          </div>

          <div style="height:8px"></div>

          <div class="small">Compartilhar</div>
          <div style="display:flex;gap:8px;margin-top:6px">
            <button class="linkBtn" id="copyPageLink">Copiar link desta página</button>
            <button class="linkBtn" id="themeToggle">Tema Claro</button>
          </div>

          <div style="height:12px"></div>

          <div class="small">Suas regras (local)</div>
          <div id="ownRulesList" style="display:flex;flex-direction:column;gap:8px;margin-top:8px"></div>
        </div>

        <div style="height:12px"></div>

        <div class="small">Status do Firebase</div>
        <div id="fbStatus" class="small" style="color:var(--muted)">—</div>
      </div>
    </div>

  </div>
</div>

<!-- MODAL -->
<div class="modalBg" id="modalBg">
  <div class="modal" role="dialog" aria-modal="true">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><div class="title" id="modalTitle"></div><div class="small" id="modalMeta"></div></div>
      <div class="closeX" id="modalClose">✖</div>
    </div>
    <div class="body" id="modalBody"></div>
    <div style="height:12px"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="linkBtn" id="modalCopy">Copiar</button>
      <button class="linkBtn" id="modalShare">Compartilhar</button>
      <button class="linkBtn" id="modalFav">Favoritar</button>
      <button class="linkBtn" id="modalEdit">Editar (token)</button>
      <button class="linkBtn" id="modalDelete" style="background:linear-gradient(90deg,#ff6b6b,#ff8c6b)">Deletar</button>
    </div>
  </div>
</div>

<!-- SCRIPTS: Firebase + App -->
<script type="module">
  // IMPORTS FIREBASE (modular)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, push, set, onValue, get, child, remove, update, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  // SUA CONFIG EXACTA (mantive a que você enviou)
  const firebaseConfig = {
    apiKey: "AIzaSyBgU_MiSKWchHcItzu62cF_RySm0EmPKIE",
    authDomain: "bancodataregrageneral.firebaseapp.com",
    databaseURL: "https://bancodataregrageneral-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "bancodataregrageneral",
    storageBucket: "bancodataregrageneral.firebasestorage.app",
    messagingSenderId: "578599910104",
    appId: "1:578599910104:web:38e9fdf1aea786376fb5ad"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const rootRef = ref(db, 'regras');

  // UTIL state
  let allRules = []; // local cache
  let filtered = [];
  let page = 1;
  const PAGE_SIZE = 7;
  let activeChip = 'Todas';
  let favorites = JSON.parse(localStorage.getItem('lm_favs')||'[]');
  let tokens = JSON.parse(localStorage.getItem('lm_tokens')||'{}'); // { ruleId: token }
  let ownRules = JSON.parse(localStorage.getItem('lm_own')||'[]'); // list of ids posted from this browser

  // DOM refs
  const rulesList = document.getElementById('rulesList');
  const searchInput = document.getElementById('searchInput');
  const chipsWrap = document.getElementById('chips');
  const stats = document.getElementById('stats');
  const pageInfo = document.getElementById('pageInfo');
  const prevPage = document.getElementById('prevPage');
  const nextPage = document.getElementById('nextPage');
  const favCount = document.getElementById('favCount');
  const ownRulesList = document.getElementById('ownRulesList');
  const fbStatus = document.getElementById('fbStatus');

  // NAV
  document.querySelectorAll('.navBtn').forEach(b=>{
    b.onclick = () => {
      document.querySelectorAll('.navBtn').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      document.querySelectorAll('#view-home,#view-new,#view-export,#view-about').forEach(v=>v.style.display='none');
      document.getElementById('view-'+b.dataset.view).style.display = 'block';
    };
  });

  // THEME toggle (simple)
  const themeToggle = document.getElementById('themeToggle');
  let light = false;
  themeToggle.onclick = ()=>{
    light = !light;
    if(light){
      document.documentElement.style.setProperty('--bg','#f6fbff');
      document.documentElement.style.setProperty('--card','#ffffff');
      document.documentElement.style.setProperty('--muted','#475569');
      document.body.style.color='#0a1b24';
      themeToggle.textContent='Tema Escuro';
    } else {
      document.documentElement.style.setProperty('--bg','#0b1116');
      document.documentElement.style.setProperty('--card','#0e1822');
      document.documentElement.style.setProperty('--muted','#9fb0c6');
      document.body.style.color='#e7f2ff';
      themeToggle.textContent='Tema Claro';
    }
  };

  // CHIPS (categories)
  const CATS = ['Todas','Geral','Comportamento','Conteúdo','Banimentos','Moderação'];
  function renderChips(){
    chipsWrap.innerHTML = '';
    CATS.forEach(c=>{
      const el = document.createElement('div'); el.className='chip'+(c===activeChip?' active':''); el.textContent=c;
      el.onclick = ()=>{ activeChip=c; page=1; render(); renderChips(); };
      chipsWrap.appendChild(el);
    });
  }
  renderChips();

  // PAGE NAV
  prevPage.onclick = ()=>{ if(page>1){ page--; render(); } };
  nextPage.onclick = ()=>{ page++; render(); };

  // load realtime from Firebase
  function markFB(status,color){
    fbStatus.textContent = status;
    fbStatus.style.color = color || 'var(--muted)';
  }
  markFB('Conectando...', '#9fb0c6');

  onValue(rootRef, snapshot=>{
    const data = snapshot.val() || {};
    allRules = Object.keys(data).map(k=>({ id:k, ...data[k] }));
    // sort newest by default
    allRules.sort((a,b)=> (b._ts||0) - (a._ts||0));
    markFB('Conectado • '+allRules.length+' regras', '#9fb0c6');
    page = 1;
    render();
    renderOwnList();
  }, (err)=>{
    markFB('Erro Firebase', '#ff8b8b');
    console.error(err);
  });

  // RENDER main list with filters, search, pagination
  function render(){
    const q = searchInput.value.trim().toLowerCase();
    filtered = allRules.filter(r=>{
      const matchCat = (activeChip==='Todas') ? true : (r.categoria === activeChip);
      const matchText = (r.titulo + ' ' + r.texto).toLowerCase().includes(q);
      return matchCat && matchText;
    });

    // sorting
    const sort = document.getElementById('sortSelect').value;
    if(sort==='new') filtered.sort((a,b)=> (b._ts||0)-(a._ts||0));
    if(sort==='old') filtered.sort((a,b)=> (a._ts||0)-(b._ts||0));
    if(sort==='category') filtered.sort((a,b)=> (a.categoria||'').localeCompare(b.categoria||''));

    const total = filtered.length;
    const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
    if(page>pages) page=pages;
    const start = (page-1)*PAGE_SIZE;
    const pageItems = filtered.slice(start, start+PAGE_SIZE);

    rulesList.innerHTML = '';
    pageItems.forEach(r=>{
      const el = document.createElement('div'); el.className='rule';
      const left = document.createElement('div'); left.className='ruleLeft';
      left.innerHTML = `<div class="title">${escapeHtml(r.titulo)}</div>
                        <div class="meta">${escapeHtml(r.texto.split('\\n').slice(0,3).join(' '))}</div>
                        <div style="margin-top:8px"><span class="tag">${r.categoria||'Geral'}</span></div>`;
      el.appendChild(left);

      const right = document.createElement('div'); right.className='ruleActions';
      const age = new Date((r._ts||Date.now())).toLocaleString('pt-BR');
      right.innerHTML = `<div class="small">${age}</div>
                         <div class="actRow">
                           <button class="linkBtn" data-id="${r.id}" data-act="view">Ver</button>
                           <button class="linkBtn" data-id="${r.id}" data-act="copy">Copiar</button>
                           <button class="linkBtn" data-id="${r.id}" data-act="share">Link</button>
                           <button class="linkBtn" data-id="${r.id}" data-act="fav">${favorites.includes(r.id)?'★':'☆'}</button>
                         </div>`;
      el.appendChild(right);

      // actions
      el.querySelectorAll('button').forEach(btn=>{
        btn.onclick = (ev)=>{
          ev.stopPropagation();
          const act = btn.dataset.act;
          const id = btn.dataset.id;
          const rule = allRules.find(x=>x.id===id);
          if(act==='view') openModal(rule);
          if(act==='copy') { navigator.clipboard.writeText(rule.titulo+'\\n\\n'+rule.texto); toast('Copiado para área de transferência'); }
          if(act==='share') { copyToClipboard(window.location.href.split('#')[0] + '#rule=' + id); toast('Link copiado'); }
          if(act==='fav') { toggleFav(id); btn.textContent = favorites.includes(id)?'★':'☆'; }
        };
      });

      // click whole card = open
      el.onclick = ()=> openModal(allRules.find(x=>x.id===r.id));
      rulesList.appendChild(el);
    });

    stats.textContent = `${total} regras • mostrando ${start+1}-${Math.min(start+pageItems.length,total)}`;
    pageInfo.textContent = `Página ${page} / ${pages}`;
    favCount.textContent = favorites.length;
  }

  // UTILS: escape for HTML display
  function escapeHtml(s){ if(!s) return ''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // TOAST (simple)
  function toast(txt){
    const el = document.createElement('div'); el.textContent=txt;
    el.style = 'position:fixed;right:18px;bottom:18px;background:#042533;color:#bff6ff;padding:10px 14px;border-radius:10px;box-shadow:0 8px 18px rgba(2,8,12,0.6);z-index:999';
    document.body.appendChild(el);
    setTimeout(()=>el.style.opacity='0',2200); setTimeout(()=>el.remove(),2600);
  }

  // FAVORITES (localStorage)
  function toggleFav(id){
    if(favorites.includes(id)) favorites = favorites.filter(x=>x!==id);
    else favorites.push(id);
    localStorage.setItem('lm_favs', JSON.stringify(favorites));
    favCount.textContent = favorites.length;
    render();
    renderOwnList();
  }
  document.getElementById('clearFavs').onclick = () => { favorites=[]; localStorage.setItem('lm_favs','[]'); render(); toast('Favoritos limpos'); };

  // OPEN MODAL
  const modalBg = document.getElementById('modalBg');
  const modalTitle = document.getElementById('modalTitle');
  const modalMeta = document.getElementById('modalMeta');
  const modalBody = document.getElementById('modalBody');
  function openModal(rule){
    modalTitle.textContent = rule.titulo;
    modalMeta.textContent = (rule.categoria || 'Geral') + ' • ' + new Date((rule._ts||Date.now())).toLocaleString('pt-BR');
    modalBody.innerHTML = '<pre style="white-space:pre-wrap;font-family:inherit;color:var(--muted);">'+escapeHtml(rule.texto)+'</pre>';
    modalBg.style.display = 'flex';

    // button hook ups
    document.getElementById('modalCopy').onclick = ()=>{ navigator.clipboard.writeText(rule.titulo + '\\n\\n' + rule.texto); toast('Copiado'); };
    document.getElementById('modalShare').onclick = ()=>{ copyToClipboard(window.location.href.split('#')[0] + '#rule=' + rule.id); toast('Link copiado'); };
    document.getElementById('modalFav').onclick = ()=>{ toggleFav(rule.id); toast('Favorito atualizado'); };
    document.getElementById('modalEdit').onclick = ()=> startEditFlow(rule);
    document.getElementById('modalDelete').onclick = ()=> startDeleteFlow(rule);
  }
  document.getElementById('modalClose').onclick = ()=> modalBg.style.display='none';
  modalBg.onclick = e => { if(e.target === modalBg) modalBg.style.display='none'; };

  // EDIT FLOW: asks for token or uses saved token
  async function startEditFlow(rule){
    const saved = tokens[rule.id];
    let token = saved || prompt('Insira o token de edição para essa regra (ou pressione OK para usar token salvo no navegador)');
    if(!token && saved) token = saved;
    if(!token){ alert('Token necessário para editar'); return; }
    // verify token with DB
    try{
      const snap = await get(child(ref(db), 'regras/'+rule.id));
      if(!snap.exists()){ alert('Regra não encontrada'); return; }
      const data = snap.val();
      if(data.token !== token){ alert('Token inválido'); return; }
      // allow edit: open simple prompt form
      const newTitle = prompt('Novo título:', data.titulo);
      if(newTitle === null) return;
      const newText = prompt('Novo texto:', data.texto);
      if(newText === null) return;
      const newCat = prompt('Nova categoria:', data.categoria||'Geral');
      // update db
      await update(ref(db,'regras/'+rule.id), { titulo: newTitle, texto: newText, categoria: newCat, _edited: Date.now() });
      toast('Regra atualizada');
      modalBg.style.display='none';
    } catch(e){ console.error(e); alert('Erro ao verificar token'); }
  }

  // DELETE FLOW
  async function startDeleteFlow(rule){
    const saved = tokens[rule.id];
    let token = saved || prompt('Insira o token de edição para deletar essa regra');
    if(!token && saved) token = saved;
    if(!token){ alert('Token necessário'); return; }
    if(!confirm('Confirmar exclusão desta regra? A ação não pode ser revertida.')) return;
    try{
      const snap = await get(child(ref(db), 'regras/'+rule.id));
      if(!snap.exists()){ alert('Regra não encontrada'); return; }
      const data = snap.val();
      if(data.token !== token){ alert('Token inválido'); return; }
      await remove(ref(db,'regras/'+rule.id));
      // cleanup local tokens/ownlist/favs
      delete tokens[rule.id]; localStorage.setItem('lm_tokens', JSON.stringify(tokens));
      ownRules = ownRules.filter(x=>x!==rule.id); localStorage.setItem('lm_own', JSON.stringify(ownRules));
      favorites = favorites.filter(x=>x!==rule.id); localStorage.setItem('lm_favs', JSON.stringify(favorites));
      toast('Regra deletada');
      modalBg.style.display='none';
    } catch(e){ console.error(e); alert('Erro ao deletar'); }
  }

  // PUBLISH new rule
  document.getElementById('publishBtn').onclick = async ()=>{
    const titulo = document.getElementById('newTitle').value.trim();
    const texto = document.getElementById('newText').value.trim();
    const categoria = document.getElementById('newCategory').value;
    if(!titulo || !texto){ alert('Preencha título e conteúdo'); return; }
    const token = randomToken(18);
    const payload = { titulo, texto, categoria, token, _ts: Date.now() };
    try{
      const newRef = push(rootRef);
      await set(newRef, payload);
      // save token locally for convenience
      tokens[newRef.key] = token; localStorage.setItem('lm_tokens', JSON.stringify(tokens));
      ownRules.push(newRef.key); localStorage.setItem('lm_own', JSON.stringify(ownRules));
      toast('Regra publicada — token salvo localmente');
      // show token to user (once)
      alert('Regra publicada! Seu token de edição (guarde com segurança):\\n\\n' + token);
      // clear form
      document.getElementById('newTitle').value=''; document.getElementById('newText').value='';
    } catch(e){ console.error(e); alert('Erro ao publicar'); }
  };

  document.getElementById('clearBtn').onclick = ()=>{ if(confirm('Limpar campos?')){ document.getElementById('newTitle').value=''; document.getElementById('newText').value=''; } };

  // export/import
  document.getElementById('exportBtn').onclick = async ()=>{
    const snap = await get(rootRef);
    const data = snap.val() || {};
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='lithmate_regras_export.json'; a.click(); URL.revokeObjectURL(url);
    toast('Exportado JSON');
  };
  document.getElementById('downloadSample').onclick = ()=>{
    const sample = [{titulo:'Regra Exemplo','texto':'Texto da regra','categoria':'Geral'}];
    const blob = new Blob([JSON.stringify(sample, null, 2)], {type:'application/json'});
    const u = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=u; a.download='sample_regras.json'; a.click(); URL.revokeObjectURL(u);
  };
  document.getElementById('importBtn').onclick = ()=> document.getElementById('importFile').click();
  document.getElementById('importFile').onchange = async (e)=>{
    const file = e.target.files[0]; if(!file) return;
    try{
      const text = await file.text(); const json = JSON.parse(text);
      if(!Array.isArray(json)){ alert('JSON precisa ser um array de regras'); return; }
      for(const r of json){
        const payload = { titulo:r.titulo||'Sem título', texto:r.texto||'', categoria:r.categoria||'Geral', token:randomToken(12), _ts: Date.now() };
        const nr = push(rootRef); await set(nr, payload);
      }
      toast('Import concluído');
      e.target.value = '';
    } catch(er){ console.error(er); alert('Erro ao importar: '+er.message); }
  };

  // helpers
  function randomToken(len=12){
    const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let s=''; for(let i=0;i<len;i++) s+=chars[Math.floor(Math.random()*chars.length)];
    return s;
  }
  // copy helper
  function copyToClipboard(txt){ navigator.clipboard.writeText(txt); }

  // search debounce
  let sd;
  searchInput.oninput = ()=>{ clearTimeout(sd); sd = setTimeout(()=>{ page=1; render(); }, 220); };

  // sort change
  document.getElementById('sortSelect').onchange = ()=>{ page=1; render(); };

  // share page
  document.getElementById('copyPageLink').onclick = ()=>{ copyToClipboard(window.location.href); toast('Link da página copiado'); };

  // load rule from URL hash if present
  function checkHash(){
    const h = location.hash;
    if(h && h.startsWith('#rule=')){
      const id = h.split('=')[1];
      if(id){
        // wait until rules loaded
        setTimeout(()=>{ const r = allRules.find(x=>x.id===id); if(r) openModal(r); else toast('Regra não encontrada'); }, 700);
      }
    }
  }
  window.addEventListener('hashchange', checkHash);
  checkHash();

  // own rules / keep list of rules created in this browser
  function renderOwnList(){
    ownRulesList.innerHTML = '';
    ownRules.forEach(id=>{
      const r = allRules.find(x=>x.id===id);
      const el = document.createElement('div'); el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center';
      el.innerHTML = `<div style="font-weight:700">${r?escapeHtml(r.titulo):'(removida)'}</div><div style="display:flex;gap:6px">
        <button class="linkBtn" data-id="${id}" data-act="goto">Ir</button>
        <button class="linkBtn" data-id="${id}" data-act="copy">Copiar</button>
      </div>`;
      el.querySelectorAll('button').forEach(b=>{
        b.onclick = ()=>{
          const act=b.dataset.act;
          const id=b.dataset.id;
          const rr = allRules.find(x=>x.id===id);
          if(act==='goto'){ if(rr) openModal(rr); else alert('Regra removida'); }
          if(act==='copy'){ if(rr){ navigator.clipboard.writeText(rr.titulo+'\\n\\n'+rr.texto); toast('Copiado'); } else alert('Regra removida'); }
        };
      });
      ownRulesList.appendChild(el);
    });
    favCount.textContent = favorites.length;
  }

  // copy page link on load
  document.getElementById('copyPageLink').onclick = ()=>{ copyToClipboard(window.location.href); toast('Link copiado'); };

  // route on nav load (default home)
  document.querySelectorAll('[data-view]').forEach(b=>{ if(b.classList.contains('active')){ document.getElementById('view-'+b.dataset.view).style.display='block'; }});

  // load tokens and ownRules from storage on start
  (function loadLocal(){
    const t = localStorage.getItem('lm_tokens'); if(t) tokens = JSON.parse(t);
    const o = localStorage.getItem('lm_own'); if(o) ownRules = JSON.parse(o);
    const f = localStorage.getItem('lm_favs'); if(f) favorites = JSON.parse(f);
    renderOwnList(); favCount.textContent = favorites.length;
  })();

  // simple route: nav buttons already handle views
  // small helper to update stats when rules change
  setInterval(()=>{ document.getElementById('stats').textContent = `${allRules.length} regras • ${filtered.length||0} visíveis`; }, 1700);

  // initial small sample if DB empty: create demo (only if truly empty)
  (async ()=>{
    const snap = await get(rootRef);
    if(!snap.exists()){
      const sample = [
        { titulo:'Respeito mútuo', texto:'Trate todos com respeito. Insultos e ofensas são proibidos.', categoria:'Geral', token:randomToken(12), _ts:Date.now() - 1000*60*60*24 },
        { titulo:'Sem conteúdo adulto', texto:'Proibido enviar nudez, pornografia ou links para conteúdo adulto.', categoria:'Conteúdo', token:randomToken(12), _ts:Date.now() - 1000*60*60*23 }
      ];
      for(const s of sample){ const n = push(rootRef); await set(n, s); }
    }
  })();

  // small helper: escape in modal pre tags okay
  // DONE
</script>
</body>
</html>
