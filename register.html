<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Afiliados GbzStudio</title>

<style>
body{
    margin:0;
    background:#0d0d0d;
    color:white;
    font-family:Arial, sans-serif;
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
}
.container{
    width:360px;
    background:#141414;
    padding:25px;
    border-radius:15px;
    box-shadow:0 0 30px #000;
}
h2{
    text-align:center;
    margin-bottom:15px;
}
input{
    width:100%;
    padding:12px;
    margin-top:10px;
    border:none;
    background:#1f1f1f;
    color:white;
    border-radius:8px;
}
button{
    width:100%;
    padding:12px;
    margin-top:20px;
    background:#6a3dff;
    border:none;
    border-radius:8px;
    color:white;
    font-size:16px;
    cursor:pointer;
}
button:hover{
    background:#825eff;
}
#status{
    margin-top:15px;
    text-align:center;
}
</style>
</head>
<body>

<div class="container">
    <h2>Registro de Afiliado</h2>

    <input id="nome" type="text" placeholder="Nome">
    <input id="sobrenome" type="text" placeholder="Sobrenome">
    <input id="idade" type="number" placeholder="Idade">
    <input id="email" type="email" placeholder="Email">
    <input id="pix" type="text" placeholder="Chave Pix">

    <button onclick="finalizar()">Finalizar Cadastro</button>

    <div id="status"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD6UyxqTZAlPLjcadS45YYj2HUEK6fTV80",
  authDomain: "bancdataofc.firebaseapp.com",
  databaseURL: "https://bancdataofc-default-rtdb.firebaseio.com",
  projectId: "bancdataofc",
  storageBucket: "bancdataofc.firebasestorage.app",
  messagingSenderId: "1032596370698",
  appId: "1:1032596370698:web:26c710d196fb2b59e876f3"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// -------- GERADOR DE CÓDIGO --------
function gerarCodigoAfiliado() {
    const caracteres = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
    let codigo = "";
    for (let i = 0; i < 8; i++) {
        codigo += caracteres[Math.floor(Math.random() * caracteres.length)];
    }
    return codigo;
}

// -------- FUNÇÃO FINALIZAR --------
async function finalizar() {
    const nome = document.getElementById("nome").value.trim();
    const sobrenome = document.getElementById("sobrenome").value.trim();
    const idade = document.getElementById("idade").value.trim();
    const email = document.getElementById("email").value.trim();
    const pix = document.getElementById("pix").value.trim();
    const status = document.getElementById("status");

    if (!nome || !sobrenome || !idade || !email || !pix) {
        status.innerHTML = "Preencha todos os campos!";
        status.style.color = "red";
        return;
    }

    let codigo = gerarCodigoAfiliado();

    const dbRef = ref(db);
    const snap = await get(child(dbRef, "afiliados"));

    if (snap.exists()) {
        const data = snap.val();
        let repetido = true;

        while (repetido) {
            repetido = false;
            for (let id in data) {
                if (data[id].codigo === codigo) {
                    repetido = true;
                    codigo = gerarCodigoAfiliado();
                }
            }
        }
    }

    const id = Date.now();

    await set(ref(db, "afiliados/" + id), {
        nome,
        sobrenome,
        idade,
        email,
        pix,
        codigo,
        criadoEm: new Date().toISOString(),
        totalVendas: 0,
        totalGanhos: 0
    });

    status.innerHTML = 
        "Cadastro concluído!<br>Seu código de afiliado é:<br><b>" + codigo + "</b>";
    status.style.color = "lightgreen";
}
</script>

</body>
</html>
